<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <title>‡〃ャlﾚﾎoｼ〃</title>
  <link rel="stylesheet" href="/assets/css/style.css" media="all" />
  <script src="assets/js/jquery-3.2.1.min.js" type="text/javascript"></script>
  <script src="/socket.io/socket.io.js" type="text/javascript"></script>
  <script type="text/javascript">
    // 1.イベントとコールバックの定義
    var socketio = io.connect('http://localhost:8080');

    socketio.on("connected", function(name) {});
    socketio.on("publish", function (data) { addMessage(data.value, data.name, data.user); });
    socketio.on("disconnect", function () {});

    // 2.イベントに絡ませる関数の定義
    function start(name) {
      socketio.emit("connected", name);
    }

    function publishMessage() {
      var textInput = document.getElementById('msg_input');
      socketio.emit("publish", {value: textInput.value, name: myName});
      textInput.value = '';
    }

    function publishMessageForVietNamese() {
      var textInput = document.getElementById('msg_input');
      var msg = textInput.value;
      var user = "[" + myName + "] ";
      socketio.emit("publish-vietnamese", {value: textInput.value, name: myName});
      textInput.value = '';
    }

    function addMessage (msg, name, user) {
      if (msg) {
        var $chat = $('.chat-talk.dummy').clone();
        $chat.removeClass('dummy');
        $chat.find('.talk-content').text(msg);
        if (name == myName) {
          $chat.addClass('mytalk');
        }
        $('.chat-frame').append($chat);
        $chat.show();
        $('body').scrollToBottom();
      }
      /*
      var domMeg = document.createElement('div');
      if(name=== void 0){
        // 入出/退出時
       domMeg.innerHTML = new Date().toLocaleTimeString() + ' 入出/退出時 ' + msg;
      }else if(name == myName){
        // 自分発言
       domMeg.innerHTML = new Date().toLocaleTimeString() + ' 自分が発言 ' + msg;
      }else {
        // 他人発言
       domMeg.innerHTML = new Date().toLocaleTimeString() + ' [' + user + '] ' + msg;
      }
      msgArea.appendChild(domMeg);
      */
    }
    
    $.fn.scrollToBottom = function() {
      if(this.length == 0 || !this[0].scrollHeight) return;
      this.animate({scrollTop: this[0].scrollHeight});
      //this.scrollTop(this[0].scrollHeight);
    };

    // 3.開始処理
    var msgArea = document.getElementById("msg");
    var myName = Math.floor(Math.random()*100) + "さん";
    start(myName);
  </script>
</head>

<body>

  <div id="chat">

    <div class="chat-frame">

      <p class="chat-talk dummy" style="display: none;">
        <span class="talk-icon">
          <img src="assets/img/ganguro_gal.png" />
        </span>
        <span class="talk-content">[トーク内容を記載]</span>
      </p>

    </div>

    <div class="chat-input">
      <input type="text" id="msg_input" placeholder="χｯ世→ｼ〃щoぃяё〒йё">
      <div class="button-area">
        <button class="btn btn-primary" onclick="publishMessage();">ぉ＜ゑ</button>
      </div>
      <div class="button-area">
        <button class="btn btn-primary" onclick="publishMessageForVietNamese();">∧ﾞ┠十厶</button>
      </div>
    </div>
    
  </div>

</body>
</html>
